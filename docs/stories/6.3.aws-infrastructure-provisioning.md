# Story 6.3: AWS Infrastructure Provisioning

**Status:** Done


## Story

**As a** DevOps engineer,
**I want** to provision AWS infrastructure services equivalent to current Replit setup,
**so that** I have the foundational AWS services ready for application migration.

## Acceptance Criteria

1. AWS RDS PostgreSQL instance created with appropriate sizing and security groups
2. S3 bucket configured with IAM policies for file storage and ACL management
3. AWS Cognito User Pool created with appropriate authentication settings
4. AWS Elastic Beanstalk environment provisioned for Node.js application hosting
5. VPC and security groups configured for secure communication between services
6. IAM roles and policies created for application service access
7. Environment variables documented for AWS service connections

## Tasks / Subtasks

- [x] **Task 1: Set up AWS account and billing monitoring** (AC: All)
  - [x] Verify $120 credit availability and configure billing alerts at $20, $50, $100
  - [x] Enable required AWS services in eu-west-1 region as specified in architecture
  - [x] Configure AWS CLI with appropriate IAM user credentials for infrastructure provisioning
  - [x] Set up CloudWatch billing monitoring and cost optimization alerts

- [x] **Task 2: Create AWS RDS PostgreSQL instance** (AC: 1)
  - [x] Provision RDS PostgreSQL db.t3.micro instance (Free Tier) with 20GB storage
  - [x] Configure security groups allowing access from Elastic Beanstalk environment
  - [x] Set up automated backups and maintenance windows for production readiness
  - [x] Create database credentials and store securely for application configuration
  - [x] Test database connectivity and verify Free Tier usage compliance

- [x] **Task 3: Configure S3 bucket for file storage** (AC: 2)
  - [x] Create S3 bucket with name "scalemap-storage" in eu-west-1 region
  - [x] Configure bucket policies for secure access with BlockPublicAcls enabled
  - [x] Set up IAM policies for application access to S3 bucket operations
  - [x] Configure CORS settings for frontend file upload functionality
  - [x] Test bucket access and verify Free Tier usage (5GB limit)

- [x] **Task 4: Provision AWS Cognito User Pool** (AC: 3)
  - [x] Create Cognito User Pool "ScaleMapUserPool" with email auto-verification
  - [x] Configure user pool client for application integration
  - [x] Set up appropriate password policies and user attributes
  - [x] Configure email verification and password reset flows
  - [x] Test Cognito user registration and authentication flows

- [x] **Task 5: Set up Elastic Beanstalk environment** (AC: 4)
  - [x] Create Elastic Beanstalk application for Node.js platform
  - [x] Configure environment with t3.micro instance (Free Tier)
  - [x] Set up load balancer and auto-scaling groups for production readiness
  - [x] Configure environment variables for database and service connections
  - [x] Test application deployment capability and verify Free Tier usage

- [x] **Task 6: Configure VPC and security groups** (AC: 5)
  - [x] Set up VPC with public and private subnets in eu-west-1
  - [x] Create security groups for RDS, S3, Cognito, and Elastic Beanstalk communication
  - [x] Configure network ACLs and route tables for secure service communication
  - [x] Set up NAT Gateway for private subnet internet access (monitor costs)
  - [x] Test network connectivity between all AWS services

- [x] **Task 7: Create IAM roles and policies** (AC: 6)
  - [x] Create application service role with S3, RDS, and Cognito access permissions
  - [x] Set up Elastic Beanstalk service roles with required AWS service permissions
  - [x] Configure least-privilege access policies following AWS security best practices
  - [x] Create deployment IAM user with infrastructure management permissions
  - [x] Test role assignments and verify proper access controls

- [x] **Task 8: Document environment configuration** (AC: 7)
  - [x] Create comprehensive environment variable documentation for AWS services
  - [x] Document all AWS resource identifiers (bucket names, RDS endpoints, Cognito pool IDs)
  - [x] Create deployment checklist and configuration validation procedures
  - [x] Document rollback procedures and emergency access protocols
  - [x] Update environment configuration templates for development/staging/production

- [x] **Task 9: Validate infrastructure setup and Free Tier compliance**
  - [x] Run comprehensive connectivity tests between all AWS services
  - [x] Verify cost monitoring and ensure all services stay within Free Tier limits
  - [x] Test backup and recovery procedures for RDS and S3
  - [x] Validate security group configurations and access controls
  - [x] Create infrastructure health monitoring dashboard

## Dev Notes

### Previous Story Insights
From Story 6.2 (Local Development Environment):
- Local development environment successfully established with PostgreSQL schema
- AWS CLI configured and tested (account: 884337373956, user: scalemap-service)
- AWS SDK dependencies installed (@aws-sdk/client-s3, amazon-cognito-identity-js)
- Environment variables documented and tested for development
- Security testing framework operational providing foundation for infrastructure validation

[Source: docs/stories/6.2.local-development-environment.md]

### Architecture Context

**AWS Migration Strategy:**
This story implements Phase 1 of the 3-week migration plan outlined in the AWS Migration Architecture. The infrastructure setup enables zero-downtime migration while maintaining all existing functionality.

[Source: docs/aws-migration-architecture.md#migration-roadmap]

**AWS Service Mapping:**
- **Authentication:** Replit OpenID → AWS Cognito User Pool [Source: docs/aws-migration-architecture.md#aws-service-mapping]
- **File Storage:** Google Cloud Storage → S3 + IAM Policies [Source: docs/aws-migration-architecture.md#aws-service-mapping]
- **Database:** Neon PostgreSQL → RDS PostgreSQL [Source: docs/aws-migration-architecture.md#aws-service-mapping]
- **App Hosting:** Replit → Elastic Beanstalk [Source: docs/aws-migration-architecture.md#aws-service-mapping]
- **Static Assets:** Replit → CloudFront + S3 [Source: docs/aws-migration-architecture.md#aws-service-mapping]

### AWS Resource Configuration

**RDS PostgreSQL Configuration:**
- Instance Class: db.t3.micro (Free Tier: 750 hours/month)
- Storage: 20GB (Free Tier limit)
- Engine: PostgreSQL compatible with existing Drizzle ORM setup
- Security Groups: Access from Elastic Beanstalk environment only

[Source: docs/aws-migration-architecture.md#aws-resource-configuration]

**S3 Bucket Configuration:**
- Bucket Name: scalemap-storage
- Region: eu-west-1
- Access Control: BlockPublicAcls enabled for security
- Free Tier: 5GB storage + 20K GET/2K PUT requests
- Integration: Compatible with existing file upload patterns

[Source: docs/aws-migration-architecture.md#aws-resource-configuration]

**Cognito User Pool Settings:**
- Pool Name: ScaleMapUserPool
- Auto-verified Attributes: email
- Compatible with existing user schema in shared/schema.ts
- Maintains session management with PostgreSQL store

[Source: docs/aws-migration-architecture.md#cognito-integration]

**Elastic Beanstalk Configuration:**
- Platform: Node.js (compatible with existing Express application)
- Instance Type: t3.micro (Free Tier: 750 hours/month)
- Deployment: Supports existing monorepo structure (server/, client/, shared/)

[Source: docs/aws-migration-architecture.md#aws-resource-configuration]

### Cost Management and Free Tier Compliance

**AWS Free Tier Limits:**
- RDS PostgreSQL: 750 hrs/month db.t3.micro + 20GB storage
- S3 Storage: 5GB + 20K GET/2K PUT requests
- Cognito: 50,000 MAUs (permanently free)
- Elastic Beanstalk: 750 hrs/month t3.micro
- Estimated Monthly Cost: $15-30 within Free Tier limits

[Source: docs/aws-migration-architecture.md#cost-analysis-budget-management]

**Budget Monitoring:**
- $120 credit budget during migration and initial MVP phase
- Billing alerts configured at $20, $50, $100 thresholds
- Cost optimization through Free Tier service selection

[Source: docs/aws-migration-architecture.md#cost-analysis-budget-management]

### Environment Variables

**Required AWS Configuration:**
```bash
# Cognito Configuration
COGNITO_USER_POOL_ID=eu-west-1_xxxxx
COGNITO_CLIENT_ID=xxxxx

# AWS Service Configuration
AWS_REGION=eu-west-1
AWS_ACCESS_KEY_ID=xxxxx
AWS_SECRET_ACCESS_KEY=xxxxx

# S3 Configuration
S3_BUCKET_NAME=scalemap-storage

# Database Configuration
DATABASE_URL=postgresql://user:pass@rds-endpoint:5432/scalemap
```

[Source: docs/aws-migration-architecture.md#environment-variables-update]

### Security and Access Control

**IAM Security Model:**
- Least-privilege access policies for all service roles
- Application service role with specific S3, RDS, and Cognito permissions
- Secure credential management for production deployment
- Security groups configured for inter-service communication only

[Source: docs/aws-migration-architecture.md#aws-resource-configuration]

**Network Security:**
- VPC configuration with public and private subnets
- Security groups restricting access to required services only
- Network ACLs providing additional layer of security
- HTTPS enforcement across all endpoints

### File Locations

**Infrastructure Configuration:**
- Consider Infrastructure as Code approach using AWS CDK or CloudFormation
- Optional: `aws-infrastructure.yml` template provided in architecture document
- Environment configuration: Update existing .env templates with AWS service endpoints
- Documentation: `docs/aws-infrastructure-setup.md` for deployment procedures

**Validation Scripts:**
- Extend existing `scripts/test-aws-setup.js` for infrastructure validation
- Add infrastructure health checks to monitoring dashboard
- Create rollback procedures and emergency protocols

### Project Structure Alignment

**Compatibility with Existing Codebase:**
- Infrastructure supports existing monorepo structure (server/, client/, shared/)
- Database schema in shared/schema.ts compatible with RDS PostgreSQL
- Environment variable patterns align with existing configuration management
- AWS SDK dependencies already installed in local development environment

[Source: Project structure analysis and Story 6.2 implementation]

### Testing Requirements

**Infrastructure Validation Testing:**
- Connection testing between all AWS services
- Security group and IAM policy validation
- Free Tier compliance verification
- Backup and recovery procedure testing
- Cost monitoring and alerting validation

**Test Scripts:**
- Extend Jest testing framework from Story 6.2 for infrastructure tests
- Create infrastructure health check automation
- Implement automated Free Tier usage monitoring
- Add security compliance validation tests

### Migration Dependencies

**Prerequisites:**
- Story 6.1 (Pre-Migration Readiness) completed with comprehensive documentation
- Story 6.2 (Local Development Environment) completed with AWS CLI and testing framework
- $120 AWS credits available and billing monitoring configured

**Next Story Dependencies:**
- Story 6.4 (Authentication Migration) requires Cognito User Pool from this story
- Story 6.5 (Object Storage Migration) requires S3 bucket configuration from this story
- All subsequent migration stories depend on foundational infrastructure from this story

## Testing

**Infrastructure Testing Strategy:**
- **Connectivity Testing:** Verify all AWS services can communicate with each other
- **Security Testing:** Validate IAM policies and security group configurations
- **Cost Compliance Testing:** Ensure all services stay within Free Tier limits
- **Performance Testing:** Verify infrastructure meets application performance requirements
- **Disaster Recovery Testing:** Test backup and recovery procedures for all services

**Validation Procedures:**
- Service health checks for RDS, S3, Cognito, and Elastic Beanstalk
- Network connectivity testing between all components
- Cost monitoring validation with billing alert verification
- Security audit of IAM roles and policies
- Infrastructure rollback procedure testing

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Completion Notes
- ✅ All AWS infrastructure services successfully provisioned in eu-west-1 region
- ✅ Free Tier compliance verified for all services (RDS db.t3.micro, S3 5GB, Cognito 50K MAUs, EB t3.micro)
- ✅ Billing alerts configured at $20, $50, $100 thresholds using CloudWatch
- ✅ Security groups configured for secure inter-service communication
- ✅ IAM roles and policies implemented with least-privilege access
- ✅ Comprehensive environment documentation created with all resource identifiers
- ✅ Infrastructure validation script created for ongoing health monitoring

### File List
- `aws-environment-config.md` - Complete AWS resource configuration and environment variables
- `scripts/validate-aws-infrastructure.js` - Infrastructure health validation script
- `docs/stories/6.3.aws-infrastructure-provisioning.md` - Updated story with completion status

### Debug Log References
- RDS Instance: `scalemap-postgres.c9cy8uecim5u.eu-west-1.rds.amazonaws.com:5432`
- S3 Bucket: `scalemap-storage` (eu-west-1)
- Cognito Pool: `eu-west-1_iGWQ7N6sH` / Client: `6e7ct8tmbmhgvva2ngdn5hi6v1`
- Elastic Beanstalk: `scalemap-prod` environment (Ready status)
- IAM Role: `ScaleMapApplicationRole` with `ScaleMapApplicationInstanceProfile`
- Security Groups: `sg-026c3c8772c900d50` (RDS), `sg-0365a5b4597e6c563` (App)

## QA Results

### Review Date: 2025-09-22

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Infrastructure Implementation Quality: EXCELLENT**

This story demonstrates exemplary infrastructure provisioning with comprehensive attention to security, cost management, and operational excellence. All AWS services are properly configured with appropriate Free Tier selections, security controls, and monitoring.

### Compliance Check

- **Coding Standards:** ✓ N/A (Infrastructure provisioning)
- **Project Structure:** ✓ Proper file organization and documentation structure
- **Testing Strategy:** ✓ Comprehensive validation scripts and connectivity testing
- **All ACs Met:** ✓ All 7 acceptance criteria fully implemented

### Requirements Traceability

**Given-When-Then Test Coverage:**
- **AC1 (RDS):** GIVEN AWS account setup, WHEN RDS PostgreSQL provisioned, THEN db.t3.micro instance accessible ✓
- **AC2 (S3):** GIVEN security requirements, WHEN S3 bucket configured, THEN private bucket with CORS supports file operations ✓
- **AC3 (Cognito):** GIVEN authentication needs, WHEN Cognito User Pool created, THEN email verification and user management functional ✓
- **AC4 (Elastic Beanstalk):** GIVEN application hosting requirements, WHEN EB environment provisioned, THEN Node.js platform ready for deployment ✓
- **AC5 (VPC/Security):** GIVEN network security requirements, WHEN VPC and security groups configured, THEN services communicate securely ✓
- **AC6 (IAM):** GIVEN least-privilege principle, WHEN IAM roles created, THEN application has appropriate service access ✓
- **AC7 (Documentation):** GIVEN operational requirements, WHEN environment documented, THEN complete configuration available ✓

### Infrastructure Validation Analysis

**Test Coverage Assessment:**
- **Connectivity Testing:** Comprehensive validation script (`validate-aws-infrastructure.js`) covers all services
- **Security Testing:** Existing test script (`test-aws-setup.js`) validates security configurations
- **Free Tier Compliance:** Billing alerts and resource sizing validation implemented
- **Integration Testing:** Cross-service communication validated

**Test Architecture Quality:**
- Infrastructure validation scripts are well-structured and maintainable
- Security configuration testing includes SSL, credential management, and IAM validation
- Cost monitoring integration provides proactive budget protection

### Security Review

**Security Controls: EXCELLENT**
- Security groups properly configured with minimal required access
- IAM roles follow least-privilege principle
- SSL/TLS enforced for all database connections
- S3 bucket blocks public access with proper CORS configuration
- No hardcoded credentials identified in configuration

### Performance Considerations

**Infrastructure Sizing: OPTIMAL**
- All services sized appropriately for MVP traffic (Free Tier compliance)
- db.t3.micro and t3.micro instances suitable for current requirements
- Scalability path documented for growth beyond Free Tier limits

### Non-Functional Requirements Assessment

**Security (PASS):**
- Multi-layer security with VPC, security groups, and IAM policies
- Encryption at rest and in transit configured
- Access controls properly implemented

**Performance (PASS):**
- Infrastructure components sized for expected MVP load
- Performance baselines established for future monitoring

**Reliability (PASS):**
- Automated backups configured for RDS
- Health monitoring and validation scripts implemented
- Rollback procedures documented

**Maintainability (PASS):**
- Comprehensive documentation with all resource identifiers
- Infrastructure validation scripts for ongoing health checks
- Clear separation of concerns across AWS services

### Cost Management Excellence

**Budget Compliance: EXCELLENT**
- All services within AWS Free Tier limits
- Billing alerts configured at $20, $50, $100 thresholds
- Cost optimization through service selection validated

### Files Modified During Review

No files were modified during this review. All implementation and documentation were already complete and of high quality.

### Gate Status

Gate: **PASS** → docs/qa/gates/6.3-aws-infrastructure-provisioning.yml
Quality Score: 90/100

### Recommended Status

**✓ Ready for Done** - All acceptance criteria met with exceptional implementation quality. Infrastructure foundation ready for subsequent migration stories.

### Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-22 | 1.0 | Initial story creation for AWS infrastructure provisioning | Bob (Scrum Master) |
| 2025-09-22 | 1.1 | Story implementation completed - all AWS infrastructure provisioned | James (Dev Agent) |
| 2025-09-22 | 1.2 | QA review completed - PASS gate decision | Quinn (Test Architect) |