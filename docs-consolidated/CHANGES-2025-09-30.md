# Changes Log - 2025-09-30

## Authentication Fix Deployment

### Code Changes

1. **client/src/lib/queryClient.ts**
   - Line 4: Changed `const API_BASE_URL` to `export const API_BASE_URL`
   - Allows other modules to import and use the centralized API base URL

2. **client/src/hooks/useAuth.ts**
   - Line 3: Added `import { API_BASE_URL } from "@/lib/queryClient"`
   - Line 16-18: Changed from relative URL to absolute URL using API_BASE_URL
   - Fixed redirect loop caused by relative API calls

3. **.env**
   - Updated `COGNITO_CLIENT_ID` from `39ckvsl8b37n7aufbp1u85umu7` to `4oh46v98dsu1c8csu4tn6ddgq1`
   - Updated `VITE_COGNITO_CLIENT_ID` from `39ckvsl8b37n7aufbp1u85umu7` to `4oh46v98dsu1c8csu4tn6ddgq1`
   - Both now use client without secret hash requirement

### Infrastructure Changes

1. **AWS Secrets Manager**
   - Updated `/scalemap/prod/cognito-config`
   - Changed clientId from `2la2nlh20tabtsus90rd2g725a` to `4oh46v98dsu1c8csu4tn6ddgq1`

2. **ECS Deployment**
   - Version: `auth-fix-20250930-140006`
   - Service restarted to load updated Secrets Manager configuration
   - Backend now validates tokens against correct client ID

3. **S3/CloudFront**
   - Frontend redeployed to correct S3 structure (root, not `/public/` subdirectory)
   - CloudFront cache fully invalidated
   - New frontend with API URL fix now live

### Documentation Updates

1. **troubleshooting-guide.md**
   - Added new section: "Authentication Redirect Loop / Invalid Token Errors"
   - Documented all three root causes and their fixes
   - Added verification commands and prevention checklist

2. **deployment-guide.md**
   - Updated frontend deployment section with S3 structure verification
   - Added critical warnings about correct directory structure
   - Enhanced verification steps with config validation

3. **environment-config.md**
   - Added critical configuration synchronization warning at top
   - Updated all Cognito Client IDs to `4oh46v98dsu1c8csu4tn6ddgq1`
   - Added comments about which configurations must match

4. **quick-reference.md**
   - Added config sync check at top of document
   - Quick command to verify Cognito Client ID consistency

5. **authentication-fix-2025-09-30.md** (NEW)
   - Complete post-mortem analysis
   - Root cause analysis for all three issues
   - Prevention strategies and lessons learned

6. **CHANGES-2025-09-30.md** (THIS FILE - NEW)
   - Summary of all changes made during fix

### Verification Results

✅ Frontend has correct API URL: `https://scalem-scale-rrvivslk5gxy-832498527.eu-west-1.elb.amazonaws.com`
✅ Secrets Manager has correct client ID: `4oh46v98dsu1c8csu4tn6ddgq1`
✅ S3 structure correct: `assets/index-*.js` at root (not `/public/assets/`)
✅ CloudFront serving new frontend: `index-StuEV1eo.js`
✅ Backend deployed and stable
✅ Authentication flow working

### Deployment Timeline

- **13:56 UTC** - Issue reported (redirect loop + 401 errors)
- **14:00 UTC** - Investigation started
- **14:06 UTC** - Docker build with fixes completed
- **14:09 UTC** - Backend deployed to ECS
- **14:12 UTC** - Backend stable
- **14:15 UTC** - Frontend deployed (incorrect path - old version still served)
- **14:17 UTC** - S3 structure issue identified
- **14:20 UTC** - Frontend redeployed with correct structure
- **14:22 UTC** - Secrets Manager updated with correct client ID
- **14:23 UTC** - Backend restarted with new config
- **14:25 UTC** - All systems verified working
- **14:30 UTC** - Documentation updates completed

### Files Modified

#### Source Code
- `client/src/lib/queryClient.ts`
- `client/src/hooks/useAuth.ts`
- `.env`

#### Documentation
- `docs-consolidated/troubleshooting-guide.md`
- `docs-consolidated/deployment-guide.md`
- `docs-consolidated/environment-config.md`
- `docs-consolidated/quick-reference.md`
- `docs-consolidated/authentication-fix-2025-09-30.md` (NEW)
- `docs-consolidated/CHANGES-2025-09-30.md` (NEW)

#### AWS Resources
- Secrets Manager: `/scalemap/prod/cognito-config`
- ECS Service: `ScalemapComputeStack-ApiServiceC9037CF0-9G3nQxFShJ53`
- S3 Bucket: `scalemap-frontend-prod-884337373956`
- CloudFront Distribution: `E1OGYBMF9QDMX9`

### Rollback Procedure (If Needed)

If issues arise, rollback with:

```bash
# 1. Revert Secrets Manager
aws secretsmanager update-secret \
  --secret-id /scalemap/prod/cognito-config \
  --region eu-west-1 \
  --secret-string '{"userPoolId":"eu-west-1_iGWQ7N6sH","clientId":"[previous-client-id]","region":"eu-west-1"}'

# 2. Rollback backend
aws ecs update-service \
  --cluster scalemap-cluster \
  --service ScalemapComputeStack-ApiServiceC9037CF0-9G3nQxFShJ53 \
  --force-new-deployment \
  --region eu-west-1

# 3. Rollback frontend (redeploy previous Docker image)
docker pull 884337373956.dkr.ecr.eu-west-1.amazonaws.com/scalemap-api:[previous-tag]
# ... extract and deploy frontend as usual
```

### Testing Checklist

- [x] Login with valid credentials succeeds
- [x] No redirect loop errors
- [x] No "Invalid token" errors
- [x] API calls go to backend ALB (not CloudFront)
- [x] Dashboard loads after successful login
- [x] User data fetched correctly
- [x] Token persists across page refresh
- [x] Logout functionality works
- [x] Browser console shows no errors

### Known Issues / Tech Debt

None related to this fix. System fully operational.

### Next Steps

1. Add automated integration tests for authentication flow
2. Create pre-deployment configuration validation script
3. Consider infrastructure-as-code for Cognito configuration
4. Add monitoring/alerting for authentication failures

---

**Prepared by:** Dev Agent James (AI)
**Date:** 2025-09-30
**Status:** Deployed & Verified
